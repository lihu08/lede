name: Build Redmi AX6 Firmware

on:
  push:
    branches: [ main, master ]
    paths: 
      - '.config'
      - '.github/workflows/build-ax6.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Clean disk space
      run: |
        # 清理系统缓存释放空间
        sudo apt clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/graalvm

    - name: Setup feeds
      run: |
        echo 'src-git helloworld https://github.com/fw876/helloworld' >> feeds.conf.default
        echo 'src-git passwall https://github.com/xiaorouji/openwrt-passwall' >> feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Install minimal dependencies
      run: |
        sudo apt update
        # 只安装最必要的依赖
        sudo apt install -y build-essential clang flex bison g++ gawk \
          gettext git libncurses5-dev libssl-dev python3 python3-pip rsync unzip zlib1g-dev \
          file wget

    - name: Apply config
      run: |
        [ -f .config ] && make defconfig || make defconfig

    - name: Download sources with cleanup
      run: |
        # 分批次下载，及时清理
        make download -j4
        # 清理小文件和临时文件
        find dl -size -1024c -delete
        sudo sync

    - name: Build with limited parallelism
      run: |
        echo "🚀 Starting compilation with disk space optimization..."
        # 使用更少的并行任务减少内存和磁盘压力
        make -j2 V=s
        # 编译完成后立即清理
        make clean

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: redmi-ax6-firmware
        path: bin/targets/ipq807x/arm64/
        retention-days: 7