name: Build Redmi AX6 Firmware

on:
  push:
    branches: [ main, master ]
    paths: 
      - '.config'
      - '.github/workflows/build-ax6.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Clean disk space
      run: |
        # æ¸…ç†ç³»ç»Ÿç¼“å­˜é‡Šæ”¾ç©ºé—´
        sudo apt clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/graalvm

    - name: Setup feeds
      run: |
        echo 'src-git helloworld https://github.com/fw876/helloworld' >> feeds.conf.default
        echo 'src-git passwall https://github.com/xiaorouji/openwrt-passwall' >> feeds.conf.default
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Install minimal dependencies
      run: |
        sudo apt update
        # åªå®‰è£…æœ€å¿…è¦çš„ä¾èµ–
        sudo apt install -y build-essential clang flex bison g++ gawk \
          gettext git libncurses5-dev libssl-dev python3 python3-pip rsync unzip zlib1g-dev \
          file wget

    - name: Apply config
      run: |
        [ -f .config ] && make defconfig || make defconfig

    - name: Download sources with cleanup
      run: |
        # åˆ†æ‰¹æ¬¡ä¸‹è½½ï¼ŒåŠæ—¶æ¸…ç†
        make download -j4
        # æ¸…ç†å°æ–‡ä»¶å’Œä¸´æ—¶æ–‡ä»¶
        find dl -size -1024c -delete
        sudo sync

    - name: Build with limited parallelism
      run: |
        echo "ğŸš€ Starting compilation with disk space optimization..."
        # ä½¿ç”¨æ›´å°‘çš„å¹¶è¡Œä»»åŠ¡å‡å°‘å†…å­˜å’Œç£ç›˜å‹åŠ›
        make -j2 V=s
        # ç¼–è¯‘å®Œæˆåç«‹å³æ¸…ç†
        make clean

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: redmi-ax6-firmware
        path: bin/targets/ipq807x/arm64/
        retention-days: 7